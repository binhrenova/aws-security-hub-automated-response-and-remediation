{
 "Description": "(DEV-SO0111C) AWS Security Hub Automated Response & Remediation CIS 1.2.0 Compliance Pack - Member Account, v1.5.1",
 "AWSTemplateFormatVersion": "2010-09-09",
 "Parameters": {
  "SecHubAdminAccount": {
   "Type": "String",
   "AllowedPattern": "^\\d{12}$",
   "Description": "Admin account number"
  },
  "WaitProviderServiceToken": {
   "Type": "String"
  },
  "Enable13": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 1.3 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable14": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 1.4 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable15": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 1.5 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable120": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 1.20 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable21": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.1 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable22": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.2 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable23": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.3 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable24": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.4 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable25": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.5 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable26": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.6 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable27": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.7 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable28": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.8 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable29": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 2.9 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable31": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 3.1 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable41": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 4.1 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  },
  "Enable43": {
   "Type": "String",
   "Default": "Available",
   "AllowedValues": [
    "Available",
    "NOT Available"
   ],
   "Description": "Enable/disable availability of remediation for CIS version 1.2.0 Control 4.3 in Security Hub Console Custom Actions. If NOT Available the remediation cannot be triggered from the Security Hub console in the Security Hub Admin account."
  }
 },
 "Conditions": {
  "Enable13Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable13"
    },
    "Available"
   ]
  },
  "Enable14Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable14"
    },
    "Available"
   ]
  },
  "Enable15Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable15"
    },
    "Available"
   ]
  },
  "Enable120Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable120"
    },
    "Available"
   ]
  },
  "Enable21Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable21"
    },
    "Available"
   ]
  },
  "Enable22Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable22"
    },
    "Available"
   ]
  },
  "Enable23Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable23"
    },
    "Available"
   ]
  },
  "Enable24Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable24"
    },
    "Available"
   ]
  },
  "Enable25Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable25"
    },
    "Available"
   ]
  },
  "Enable26Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable26"
    },
    "Available"
   ]
  },
  "Enable27Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable27"
    },
    "Available"
   ]
  },
  "Enable28Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable28"
    },
    "Available"
   ]
  },
  "Enable29Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable29"
    },
    "Available"
   ]
  },
  "Enable31Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable31"
    },
    "Available"
   ]
  },
  "Enable41Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable41"
    },
    "Available"
   ]
  },
  "Enable43Condition": {
   "Fn::Equals": [
    {
     "Ref": "Enable43"
    },
    "Available"
   ]
  }
 },
 "Resources": {
  "ControlCIS13": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_1.3\n\n## What does this document do?\nThis document ensures that credentials unused for 90 days or greater are disabled.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Output of DescribeAutoScalingGroups API.\n\n## Documentation Links\n* [CIS v1.2.0 1.3](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.3)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 1.3 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "IAMUser",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "IAMResourceId",
         "Selector": "$.Payload.details.AwsIamUser.UserId",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):iam::\\d{12}:user(?:(?:\\u002F)|(?:\\u002F[\\u0021-\\u007F]{1,510}\\u002F))([\\w+=,.@-]{1,64})$",
         "expected_control_id": [
          "1.3"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-RevokeUnusedIAMUserCredentials",
        "RuntimeParameters": {
         "IAMResourceId": "{{ ParseInput.IAMResourceId }}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-RevokeUnusedIAMUserCredentials"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Deactivated unused keys and expired logins for {{ ParseInput.IAMUser }}.",
         "UpdatedBy": "ASR-CIS_1.2.0_1.3"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_1.3",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait0"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 1.3"
   },
   "Condition": "Enable13Condition"
  },
  "ControlCIS14": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_1.4\n\n## What does this document do?\nThis document disables active keys that have not been rotated for more than 90 days. Note that this remediation is **DISRUPTIVE**.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output\n\n## Documentation Links\n* [CIS v1.2.0 1.4](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.4)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 1.4 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "MaxCredentialUsageAge": {
       "type": "String",
       "description": "(Required) Maximum number of days a key can be unrotated. The default value is 90 days.",
       "allowedPattern": "^(?:[1-9]\\d{0,3}|10000)$",
       "default": "90"
      },
      "RemediationRoleName": {
       "type": "String",
       "default": "SO0111-RevokeUnrotatedKeys",
       "allowedPattern": "^[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "IAMUser",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "IAMResourceId",
         "Selector": "$.Payload.details.AwsIamUser.UserId",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):iam::\\d{12}:user(?:(?:\\u002F)|(?:\\u002F[\\u0021-\\u007F]{1,510}\\u002F))([\\w+=,.@-]{1,64})$",
         "expected_control_id": [
          "1.4"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-RevokeUnrotatedKeys",
        "RuntimeParameters": {
         "IAMResourceId": "{{ ParseInput.IAMResourceId }}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/{{RemediationRoleName}}",
         "MaxCredentialUsageAge": "{{MaxCredentialUsageAge}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Deactivated unrotated keys for {{ ParseInput.IAMUser }}.",
         "UpdatedBy": "ASR-CIS_1.2.0_1.4"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_1.4",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait0"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 1.4"
   },
   "Condition": "Enable14Condition"
  },
  "ControlCIS15": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_1.5\n\n## What does this document do?\nThis document establishes a default password policy.\n\n## Security Standards and Controls\n* CIS 1.5 - 1.11\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n## Output Parameters\n* Remediation.Output\n\n## Documentation Links\n* [CIS v1.2.0 1.5](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.5)\n* [CIS v1.2.0 1.6](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.6)\n* [CIS v1.2.0 1.7](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.7)\n* [CIS v1.2.0 1.8](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.8)\n* [CIS v1.2.0 1.9](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.9)\n* [CIS v1.2.0 1.10](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.10)\n* [CIS v1.2.0 1.11](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.11)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 1.5 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "",
         "expected_control_id": [
          "1.5",
          "1.6",
          "1.7",
          "1.8",
          "1.9",
          "1.10",
          "1.11"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-SetIAMPasswordPolicy",
        "RuntimeParameters": {
         "AllowUsersToChangePassword": true,
         "HardExpiry": true,
         "MaxPasswordAge": 90,
         "MinimumPasswordLength": 14,
         "RequireSymbols": true,
         "RequireNumbers": true,
         "RequireUppercaseCharacters": true,
         "RequireLowercaseCharacters": true,
         "PasswordReusePrevention": 24,
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-SetIAMPasswordPolicy"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Established a baseline password policy using the AWSConfigRemediation-SetIAMPasswordPolicy runbook.",
         "UpdatedBy": "ASR-CIS_1.2.0_1.5"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_1.5",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait0"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 1.5"
   },
   "Condition": "Enable15Condition"
  },
  "ControlCIS120": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_1.20\n\n## What does this document do?\nCreates a support role to allow AWS Support access.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Output of CREATEROLE API.\n\n## Documentation Links\n* [CIS v1.2.0 1.20](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-1.20)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 1.20 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "Account",
         "Selector": "$.Payload.account_id",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "",
         "expected_control_id": [
          "1.20"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-CreateIAMSupportRole",
        "RuntimeParameters": {
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-CreateIAMSupportRole"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "AWS Support Role created for {{ global:ACCOUNT_ID }}.",
         "UpdatedBy": "ASR-CIS_1.2.0_1.20"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_1.20",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait0"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 1.20"
   },
   "Condition": "Enable120Condition"
  },
  "ControlCIS21": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.1\n\n## What does this document do?\nCreates a multi-region trail with KMS encryption and enables CloudTrail\nNote: this remediation will create a NEW trail.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Documentation Links\n* [CIS v1.2.0 2.1](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.1)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "parameters": {
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.1 finding"
      },
      "KMSKeyArn": {
       "type": "String",
       "default": "{{ssm:/Solutions/SO0111/CMK_REMEDIATION_ARN}}",
       "description": "The ARN of the KMS key created by ASR for this remediation",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):kms:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:(?:(?:alias/[A-Za-z0-9/-_])|(?:key/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})))$"
      }
     },
     "outputs": [
      "Remediation.Output",
      "ParseInput.AffectedObject"
     ],
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "ResourceId",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "AWSPartition",
         "Selector": "$.Payload.partition",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "",
         "expected_control_id": [
          "2.1"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-CreateCloudTrailMultiRegionTrail",
        "RuntimeParameters": {
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-CreateCloudTrailMultiRegionTrail",
         "AWSPartition": "{{global:AWS_PARTITION}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Multi-region, encrypted AWS CloudTrail successfully created",
         "UpdatedBy": "ASR-CIS_1.2.0_2.11"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.1",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait0"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.1"
   },
   "Condition": "Enable21Condition"
  },
  "ControlCIS22": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.2\n\n## What does this document do?\nThis document enables CloudTrail log file validation.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output\n\n## Documentation Links\n* [CIS v1.2.0 2.2](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.2)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.2 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "RemediationRoleName": {
       "type": "String",
       "default": "SO0111-EnableCloudTrailLogFileValidation",
       "allowedPattern": "^[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "TrailName",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "RemediationRegion",
         "Selector": "$.Payload.resource_region",
         "Type": "String"
        },
        {
         "Name": "RemediationAccount",
         "Selector": "$.Payload.account_id",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):cloudtrail:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:trail/([A-Za-z0-9._-]{3,128})$",
         "expected_control_id": [
          "2.2"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-EnableCloudTrailLogFileValidation",
        "TargetLocations": [
         {
          "Accounts": [
           "{{ParseInput.RemediationAccount}}"
          ],
          "Regions": [
           "{{ParseInput.RemediationRegion}}"
          ],
          "ExecutionRoleName": "{{RemediationRoleName}}"
         }
        ],
        "RuntimeParameters": {
         "TrailName": "{{ParseInput.TrailName}}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/{{RemediationRoleName}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Enabled CloudTrail log file validation.",
         "UpdatedBy": "ASR-CIS_1.2.0_2.2"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.2",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait1"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.2"
   },
   "Condition": "Enable22Condition"
  },
  "ControlCIS23": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.3\n\n## What does this document do?\nThis document blocks public access to the CloudTrail S3 bucket.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output\n\n## Documentation Links\n* [CIS v1.2.0 2.3](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.3)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.3 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "BucketName",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):s3:::([A-Za-z0-9.-]{3,63})$",
         "expected_control_id": [
          "2.3"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-ConfigureS3BucketPublicAccessBlock",
        "RuntimeParameters": {
         "BucketName": "{{ParseInput.BucketName}}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-ConfigureS3BucketPublicAccessBlock",
         "RestrictPublicBuckets": true,
         "BlockPublicAcls": true,
         "IgnorePublicAcls": true,
         "BlockPublicPolicy": true
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Disabled public access to CloudTrail logs bucket.",
         "UpdatedBy": "ASR-CIS_1.2.0_2.3"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.3",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait1"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.3"
   },
   "Condition": "Enable23Condition"
  },
  "ControlCIS24": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.4\n\n## What does this document do?\nThis document configures CloudTrail to log to CloudWatch Logs.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Remediation results\n\n## Documentation Links\n* [CIS v1.2.0 2.4](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.4)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.4 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "RemediationRoleName": {
       "type": "String",
       "default": "SO0111-EnableCloudTrailToCloudWatchLogging",
       "allowedPattern": "^[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "TrailName",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "RemediationRegion",
         "Selector": "$.Payload.resource_region",
         "Type": "String"
        },
        {
         "Name": "RemediationAccount",
         "Selector": "$.Payload.account_id",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):cloudtrail:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:trail/([A-Za-z0-9._-]{3,128})$",
         "expected_control_id": [
          "2.4"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-EnableCloudTrailToCloudWatchLogging",
        "TargetLocations": [
         {
          "Accounts": [
           "{{ParseInput.RemediationAccount}}"
          ],
          "Regions": [
           "{{ParseInput.RemediationRegion}}"
          ],
          "ExecutionRoleName": "{{RemediationRoleName}}"
         }
        ],
        "RuntimeParameters": {
         "TrailName": "{{ ParseInput.TrailName }}",
         "CloudWatchLogsRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-CloudTrailToCloudWatchLogs",
         "LogGroupName": "CloudTrail/{{ParseInput.TrailName}}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/{{RemediationRoleName}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Configured CloudTrail logging to CloudWatch Logs Group CloudTrail/{{ParseInput.TrailName}}",
         "UpdatedBy": "ASR-CIS_1.2.0_2.4"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.4",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait1"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.4"
   },
   "Condition": "Enable24Condition"
  },
  "ControlCIS25": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.5\n## What does this document do?\nEnables AWS Config:\n* Turns on recording for all resources.\n* Creates an encrypted bucket for Config logging.\n* Creates a logging bucket for access logs for the config bucket\n* Creates an SNS topic for Config notifications\n* Creates a service-linked role\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Documentation Links\n* [CIS v1.2.0 2.5](https://docs.aws.amazon.com/console/securityhub/standards-cis-2.5/remediation)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "parameters": {
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.5 finding"
      },
      "KMSKeyArn": {
       "type": "String",
       "default": "{{ssm:/Solutions/SO0111/CMK_REMEDIATION_ARN}}",
       "description": "The ARN of the KMS key created by ASR for remediations",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):kms:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:(?:(?:alias/[A-Za-z0-9/-_])|(?:key/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})))$"
      }
     },
     "outputs": [
      "Remediation.Output",
      "ParseInput.AffectedObject"
     ],
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "",
         "expected_control_id": [
          "2.5"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-EnableAWSConfig",
        "RuntimeParameters": {
         "SNSTopicName": "SO0111-SHARR-AWSConfigNotification",
         "KMSKeyArn": "{{KMSKeyArn}}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-EnableAWSConfig"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "AWS Config enabled",
         "UpdatedBy": "ASR-CIS_1.2.0_2.5"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.5",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait1"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.5"
   },
   "Condition": "Enable25Condition"
  },
  "ControlCIS26": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.6\n\n## What does this document do?\nConfigures access logging for a CloudTrail S3 bucket.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Remediation results\n\n## Documentation Links\n* [CIS v1.2.0 2.6](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.6)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.6 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "CloudTrailBucket",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):s3:::([a-z0-9.-]{3,63})$",
         "expected_control_id": [
          "2.6"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "CreateAccessLoggingBucket",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-CreateAccessLoggingBucket",
        "RuntimeParameters": {
         "BucketName": "so0111-cloudtrailaccesslogs-{{global:ACCOUNT_ID}}-{{global:REGION}}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-CreateAccessLoggingBucket"
        }
       }
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "AWS-ConfigureS3BucketLogging",
        "RuntimeParameters": {
         "BucketName": "{{ParseInput.CloudTrailBucket}}",
         "GrantedPermission": [
          "READ"
         ],
         "GranteeType": [
          "Group"
         ],
         "GranteeUri": [
          "http://acs.amazonaws.com/groups/s3/LogDelivery"
         ],
         "TargetPrefix": [
          "{{ParseInput.CloudTrailBucket}}/"
         ],
         "TargetBucket": [
          "so0111-cloudtrailaccesslogs-{{global:ACCOUNT_ID}}-{{global:REGION}}"
         ],
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-ConfigureS3BucketLogging"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Created S3 bucket so0111-cloudtrailaccesslogs-{{global:ACCOUNT_ID}}-{{global:REGION}} for logging access to {{ParseInput.CloudTrailBucket}}",
         "UpdatedBy": "ASR-CIS_1.2.0_2.6"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.6",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait1"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.6"
   },
   "Condition": "Enable26Condition"
  },
  "ControlCIS27": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.7\n## What does this document do?\nThis document enables SSE KMS encryption for log files using the ASR remediation KMS CMK\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n## Output Parameters\n* Remediation.Output - Output from UpdateTrail API\n## Documentation Links\n* [CIS v1.2.0 2.7](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.7)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "Remediation.Output",
      "ParseInput.AffectedObject"
     ],
     "parameters": {
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.7 finding"
      },
      "KMSKeyArn": {
       "type": "String",
       "default": "{{ssm:/Solutions/SO0111/CMK_REMEDIATION_ARN}}",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):kms:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:(?:(?:alias/[A-Za-z0-9/-_])|(?:key/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})))$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "TrailArn",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "TrailRegion",
         "Selector": "$.Payload.resource_region",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "",
         "expected_control_id": [
          "2.7"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       }
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "inputs": {
        "DocumentName": "ASR-EnableCloudTrailEncryption",
        "RuntimeParameters": {
         "TrailRegion": "{{ParseInput.TrailRegion}}",
         "TrailArn": "{{ParseInput.TrailArn}}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-EnableCloudTrailEncryption",
         "KMSKeyArn": "{{KMSKeyArn}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Encryption enabled on CloudTrail {{ParseInput.TrailArn}}",
         "UpdatedBy": "ASR-CIS_1.2.0_2.7"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.7",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait2"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.7"
   },
   "Condition": "Enable27Condition"
  },
  "ControlCIS28": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.8\n\n## What does this document do?\nEnables rotation for customer-managed KMS keys.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Remediation results\n\n## Documentation Links\n* [CIS v1.2.0 2.8](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.8)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.8 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "RemediationRoleName": {
       "type": "String",
       "default": "SO0111-EnableKeyRotation",
       "allowedPattern": "^[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "KMSKeyId",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "RemediationRegion",
         "Selector": "$.Payload.resource_region",
         "Type": "String"
        },
        {
         "Name": "RemediationAccount",
         "Selector": "$.Payload.account_id",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):kms:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:key/([A-Za-z0-9-]{36})$",
         "expected_control_id": [
          "2.8"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       }
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "inputs": {
        "DocumentName": "ASR-EnableKeyRotation",
        "TargetLocations": [
         {
          "Accounts": [
           "{{ParseInput.RemediationAccount}}"
          ],
          "Regions": [
           "{{ParseInput.RemediationRegion}}"
          ],
          "ExecutionRoleName": "{{RemediationRoleName}}"
         }
        ],
        "RuntimeParameters": {
         "KeyId": "{{ParseInput.KMSKeyId}}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/{{RemediationRoleName}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Enabled KMS Customer Managed Key rotation for {{ParseInput.KMSKeyId}}",
         "UpdatedBy": "ASR-CIS_1.2.0_2.8"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.8",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait2"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.8"
   },
   "Condition": "Enable28Condition"
  },
  "ControlCIS29": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_2.9\n\n## What does this document do?\nEnables VPC Flow Logs for a VPC\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Remediation results\n\n## Documentation Links\n* [CIS v1.2.0 2.9](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-2.9)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 2.9 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "VPC",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):ec2:.*:\\d{12}:vpc/(vpc-[0-9a-f]{8,17})$",
         "expected_control_id": [
          "2.9"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-EnableVPCFlowLogs",
        "RuntimeParameters": {
         "VPC": "{{ParseInput.VPC}}",
         "RemediationRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-EnableVPCFlowLogs-remediationRole",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-EnableVPCFlowLogs"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Enabled VPC Flow Logs for {{ParseInput.VPC}}",
         "UpdatedBy": "ASR-CIS_1.2.0_2.9"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_2.9",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait2"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 2.9"
   },
   "Condition": "Enable29Condition"
  },
  "ControlCIS31": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_3.x\n\n## What does this document do?\nRemediates the following CIS findings:\n\n3.1 - Creates a log metric filter and alarm for unauthorized API calls\n3.2 - Creates a log metric filter and alarm for AWS Management Console sign-in without MFA\n3.3 - Creates a log metric filter and alarm for usage of \"root\" account\n3.4 - Creates a log metric filter and alarm for for IAM policy changes\n3.5 - Creates a log metric filter and alarm for CloudTrail configuration changes\n3.6 - Creates a log metric filter and alarm for AWS Management Console authentication failures\n3.7 - Creates a log metric filter and alarm for disabling or scheduled deletion of customer created CMKs\n3.8 - Creates a log metric filter and alarm for S3 bucket policy changes\n3.9 - Creates a log metric filter and alarm for AWS Config configuration changes\n3.10 - Creates a log metric filter and alarm for security group changes\n3.11 - Creates a log metric filter and alarm for changes to Network Access Control Lists (NACL)\n3.12 - Creates a log metric filter and alarm for changes to network gateways\n3.13 - Creates a log metric filter and alarm for route table changes\n3.14 - Creates a log metric filter and alarm for VPC changes\n\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Output of remediation runbook.\n\n## Documentation Links\n[CIS v1.2.0 3.1](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.1)\n[CIS v1.2.0 3.2](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.2)\n[CIS v1.2.0 3.3](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.3)\n[CIS v1.2.0 3.4](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.4)\n[CIS v1.2.0 3.5](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.5)\n[CIS v1.2.0 3.6](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.6)\n[CIS v1.2.0 3.7](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.7)\n[CIS v1.2.0 3.8](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.8)\n[CIS v1.2.0 3.9](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.9)\n[CIS v1.2.0 3.10](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.10)\n[CIS v1.2.0 3.11](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.11)\n[CIS v1.2.0 3.12](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.12)\n[CIS v1.2.0 3.13](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.13)\n[CIS v1.2.0 3.14](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-3.14)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 3.1 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "LogGroupName": {
       "type": "String",
       "default": "{{ssm:/Solutions/SO0111/Metrics_LogGroupName}}",
       "description": "The name of the Log group to be used to create filters and metric alarms",
       "allowedPattern": ".*"
      },
      "MetricNamespace": {
       "type": "String",
       "default": "LogMetrics",
       "description": "The name of the metric namespace where the metrics will be logged",
       "allowedPattern": ".*"
      },
      "KMSKeyArn": {
       "type": "String",
       "default": "{{ssm:/Solutions/SO0111/CMK_REMEDIATION_ARN}}",
       "description": "The ARN of the KMS key created by ASR for remediations",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):kms:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:(?:(?:alias/[A-Za-z0-9/-_])|(?:key/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})))$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "GroupId",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "ControlId",
         "Selector": "$.Payload.control_id",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "parse_id_pattern": "",
         "Finding": "{{Finding}}",
         "expected_control_id": [
          "3.1",
          "3.2",
          "3.3",
          "3.4",
          "3.5",
          "3.6",
          "3.7",
          "3.8",
          "3.9",
          "3.10",
          "3.11",
          "3.12",
          "3.13",
          "3.14"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "GetMetricFilterAndAlarmInputValue",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "FilterName",
         "Selector": "$.Payload.filter_name",
         "Type": "String"
        },
        {
         "Name": "FilterPattern",
         "Selector": "$.Payload.filter_pattern",
         "Type": "String"
        },
        {
         "Name": "MetricName",
         "Selector": "$.Payload.metric_name",
         "Type": "String"
        },
        {
         "Name": "MetricValue",
         "Selector": "$.Payload.metric_value",
         "Type": "Integer"
        },
        {
         "Name": "AlarmName",
         "Selector": "$.Payload.alarm_name",
         "Type": "String"
        },
        {
         "Name": "AlarmDesc",
         "Selector": "$.Payload.alarm_desc",
         "Type": "String"
        },
        {
         "Name": "AlarmThreshold",
         "Selector": "$.Payload.alarm_threshold",
         "Type": "Integer"
        }
       ],
       "inputs": {
        "InputPayload": {
         "ControlId": "{{ParseInput.ControlId}}",
         "StandardLongName": "cis-aws-foundations-benchmark",
         "StandardVersion": "1.2.0"
        },
        "Runtime": "python3.8",
        "Handler": "verify",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\n\nunauthorizedAPICallsFilter = {\n        \"filter_name\": \"UnauthorizedAPICalls\",\n        \"filter_pattern\": '{($.errorCode=\"*UnauthorizedOperation\") || ($.errorCode=\"AccessDenied*\")}',\n        \"metric_name\": \"UnauthorizedAPICalls\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"UnauthorizedAPICalls\",\n        \"alarm_desc\": \"Alarm for UnauthorizedAPICalls > 0\",\n        \"alarm_threshold\": 1\n}\n\nconsoleSignInWithoutMFAFilter = {\n        \"filter_name\": \"ConsoleSigninWithoutMFA\",\n        \"filter_pattern\": '{($.eventName=\"ConsoleLogin\") && ($.additionalEventData.MFAUsed !=\"Yes\")}',\n        \"metric_name\": \"ConsoleSigninWithoutMFA\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"ConsoleSigninWithoutMFA\",\n        \"alarm_desc\": \"Alarm for ConsoleSigninWithoutMFA > 0\",\n        \"alarm_threshold\": 1\n }\n\nrootAccountUsageFilter = {\n        \"filter_name\": \"RootAccountUsage\",\n        \"filter_pattern\": '{$.userIdentity.type=\"Root\" && $.userIdentity.invokedBy NOT EXISTS && $.eventType !=\"AwsServiceEvent\"}',\n        \"metric_name\": \"RootAccountUsage\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"RootAccountUsage\",\n        \"alarm_desc\": \"Alarm for RootAccountUsage > 0\",\n        \"alarm_threshold\": 1\n}\n\niamPolicyChangesFilter = {\n        \"filter_name\": \"IAMPolicyChanges\",\n        \"filter_pattern\": '{($.eventName=DeleteGroupPolicy) || ($.eventName=DeleteRolePolicy) || ($.eventName=DeleteUserPolicy) || ($.eventName=PutGroupPolicy) || ($.eventName=PutRolePolicy) || ($.eventName=PutUserPolicy) || ($.eventName=CreatePolicy) || ($.eventName=DeletePolicy) || ($.eventName=CreatePolicyVersion) || ($.eventName=DeletePolicyVersion) || ($.eventName=AttachRolePolicy) || ($.eventName=DetachRolePolicy) || ($.eventName=AttachUserPolicy) || ($.eventName=DetachUserPolicy) || ($.eventName=AttachGroupPolicy) || ($.eventName=DetachGroupPolicy)}',\n        \"metric_name\": \"IAMPolicyChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"IAMPolicyChanges\",\n        \"alarm_desc\": \"Alarm for IAMPolicyChanges > 0\",\n        \"alarm_threshold\": 1\n }\n\ncloudtrailChangesFilter = {\n        \"filter_name\": \"CloudTrailChanges\",\n        \"filter_pattern\": '{($.eventName=CreateTrail) || ($.eventName=UpdateTrail) || ($.eventName=DeleteTrail) || ($.eventName=StartLogging) || ($.eventName=StopLogging)}',\n        \"metric_name\": \"CloudTrailChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"CloudTrailChanges\",\n        \"alarm_desc\": \"Alarm for CloudTrailChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nconsoleAuthenticationFailureFilter = {\n        \"filter_name\": \"ConsoleAuthenticationFailure\",\n        \"filter_pattern\": '{($.eventName=ConsoleLogin) && ($.errorMessage=\"Failed authentication\")}',\n        \"metric_name\": \"ConsoleAuthenticationFailure\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"ConsoleAuthenticationFailure\",\n        \"alarm_desc\": \"Alarm for ConsoleAuthenticationFailure > 0\",\n        \"alarm_threshold\": 1\n }\n\ndisableOrDeleteCMKFilter = {\n        \"filter_name\": \"DisableOrDeleteCMK\",\n        \"filter_pattern\": '{($.eventSource=kms.amazonaws.com) && (($.eventName=DisableKey) || ($.eventName=ScheduleKeyDeletion))}',\n        \"metric_name\": \"DisableOrDeleteCMK\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"DisableOrDeleteCMK\",\n        \"alarm_desc\": \"Alarm for DisableOrDeleteCMK > 0\",\n        \"alarm_threshold\": 1\n}\n\ns3BucketPolicyChangesFilter = {\n        \"filter_name\": \"S3BucketPolicyChanges\",\n        \"filter_pattern\": '{($.eventSource=s3.amazonaws.com) && (($.eventName=PutBucketAcl) || ($.eventName=PutBucketPolicy) || ($.eventName=PutBucketCors) || ($.eventName=PutBucketLifecycle) || ($.eventName=PutBucketReplication) || ($.eventName=DeleteBucketPolicy) || ($.eventName=DeleteBucketCors) || ($.eventName=DeleteBucketLifecycle) || ($.eventName=DeleteBucketReplication))}',\n        \"metric_name\": \"S3BucketPolicyChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"S3BucketPolicyChanges\",\n        \"alarm_desc\": \"Alarm for S3BucketPolicyChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nawsConfigChangesFilter = {\n        \"filter_name\": \"AWSConfigChanges\",\n        \"filter_pattern\": '{($.eventSource=config.amazonaws.com) && (($.eventName=StopConfigurationRecorder) || ($.eventName=DeleteDeliveryChannel) || ($.eventName=PutDeliveryChannel) || ($.eventName=PutConfigurationRecorder))}',\n        \"metric_name\": \"AWSConfigChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"AWSConfigChanges\",\n        \"alarm_desc\": \"Alarm for AWSConfigChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nsecurityGroupChangesFilter = {\n        \"filter_name\": \"SecurityGroupChanges\",\n        \"filter_pattern\": '{($.eventName=AuthorizeSecurityGroupIngress) || ($.eventName=AuthorizeSecurityGroupEgress) || ($.eventName=RevokeSecurityGroupIngress) || ($.eventName=RevokeSecurityGroupEgress) || ($.eventName=CreateSecurityGroup) || ($.eventName=DeleteSecurityGroup)}',\n        \"metric_name\": \"SecurityGroupChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"SecurityGroupChanges\",\n        \"alarm_desc\": \"Alarm for SecurityGroupChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nnetworkACLChangesFilter = {\n        \"filter_name\": \"NetworkACLChanges\",\n        \"filter_pattern\": '{($.eventName=CreateNetworkAcl) || ($.eventName=CreateNetworkAclEntry) || ($.eventName=DeleteNetworkAcl) || ($.eventName=DeleteNetworkAclEntry) || ($.eventName=ReplaceNetworkAclEntry) || ($.eventName=ReplaceNetworkAclAssociation)}',\n        \"metric_name\": \"NetworkACLChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"NetworkACLChanges\",\n        \"alarm_desc\": \"Alarm for NetworkACLChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nnetworkGatewayChangesFilter = {\n        \"filter_name\": \"NetworkGatewayChanges\",\n        \"filter_pattern\": '{($.eventName=CreateCustomerGateway) || ($.eventName=DeleteCustomerGateway) || ($.eventName=AttachInternetGateway) || ($.eventName=CreateInternetGateway) || ($.eventName=DeleteInternetGateway) || ($.eventName=DetachInternetGateway)}',\n        \"metric_name\": \"NetworkGatewayChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"NetworkGatewayChanges\",\n        \"alarm_desc\": \"Alarm for NetworkGatewayChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nrouteTableChangesFilter = {\n        \"filter_name\": \"RouteTableChanges\",\n        \"filter_pattern\": '{($.eventName=CreateRoute) || ($.eventName=CreateRouteTable) || ($.eventName=ReplaceRoute) || ($.eventName=ReplaceRouteTableAssociation) || ($.eventName=DeleteRouteTable) || ($.eventName=DeleteRoute) || ($.eventName=DisassociateRouteTable)}',\n        \"metric_name\": \"RouteTableChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"RouteTableChanges\",\n        \"alarm_desc\": \"Alarm for RouteTableChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nvpcChangesFilter = {\n        \"filter_name\": \"VPCChanges\",\n        \"filter_pattern\": '{($.eventName=CreateVpc) || ($.eventName=DeleteVpc) || ($.eventName=ModifyVpcAttribute) || ($.eventName=AcceptVpcPeeringConnection) || ($.eventName=CreateVpcPeeringConnection) || ($.eventName=DeleteVpcPeeringConnection) || ($.eventName=RejectVpcPeeringConnection) || ($.eventName=AttachClassicLinkVpc) || ($.eventName=DetachClassicLinkVpc) || ($.eventName=DisableVpcClassicLink) || ($.eventName=EnableVpcClassicLink)}',\n        \"metric_name\": \"VPCChanges\",\n        \"metric_value\": 1,\n        \"alarm_name\": \"VPCChanges\",\n        \"alarm_desc\": \"Alarm for VPCChanges > 0\",\n        \"alarm_threshold\": 1\n}\n\nCloudwatch_mappings = {\n    'cis-aws-foundations-benchmark': {\n        '1.2.0': {\n            '3.1': unauthorizedAPICallsFilter,\n            '3.2': consoleSignInWithoutMFAFilter,\n            '3.3': rootAccountUsageFilter,\n            '3.4': iamPolicyChangesFilter,\n            '3.5': cloudtrailChangesFilter,\n            '3.6': consoleAuthenticationFailureFilter,\n            '3.7': disableOrDeleteCMKFilter,\n            '3.8': s3BucketPolicyChangesFilter,\n            '3.9': awsConfigChangesFilter,\n            '3.10': securityGroupChangesFilter,\n            '3.11': networkACLChangesFilter,\n            '3.12': networkGatewayChangesFilter,\n            '3.13': routeTableChangesFilter,\n            '3.14': vpcChangesFilter\n        },\n        '1.4.0': {\n            '4.3': rootAccountUsageFilter,\n            '4.4': iamPolicyChangesFilter,\n            '4.5': cloudtrailChangesFilter,\n            '4.6': consoleAuthenticationFailureFilter,\n            '4.7': disableOrDeleteCMKFilter,\n            '4.8': s3BucketPolicyChangesFilter,\n            '4.9': awsConfigChangesFilter,\n            '4.10': securityGroupChangesFilter,\n            '4.11': networkACLChangesFilter,\n            '4.12': networkGatewayChangesFilter,\n            '4.13': routeTableChangesFilter,\n            '4.14': vpcChangesFilter\n        }\n    },\n    'security-control': {\n        '2.0.0': {\n           \"CloudWatch.1\": rootAccountUsageFilter,\n           \"CloudWatch.2\": unauthorizedAPICallsFilter,\n           \"CloudWatch.3\": consoleSignInWithoutMFAFilter,\n           \"CloudWatch.4\": iamPolicyChangesFilter,\n           \"CloudWatch.5\": cloudtrailChangesFilter,\n           \"CloudWatch.6\": consoleAuthenticationFailureFilter,\n           \"CloudWatch.7\": disableOrDeleteCMKFilter,\n           \"CloudWatch.8\": s3BucketPolicyChangesFilter,\n           \"CloudWatch.9\": awsConfigChangesFilter,\n           \"CloudWatch.10\": securityGroupChangesFilter,\n           \"CloudWatch.11\": networkACLChangesFilter,\n           \"CloudWatch.12\": networkGatewayChangesFilter,\n           \"CloudWatch.13\": routeTableChangesFilter,\n           \"CloudWatch.14\": vpcChangesFilter\n        }\n    }\n}\n\ndef verify(event, _):\n    try:\n        standard_mapping = Cloudwatch_mappings.get(event['StandardLongName']).get(event['StandardVersion'])\n        return standard_mapping.get(event['ControlId'], None) \n    except KeyError as ex:\n        exit(f'ERROR: Could not find associated metric filter. Missing parameter: {str(ex)}')\n\n "
       }
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-CreateLogMetricFilterAndAlarm",
        "RuntimeParameters": {
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/SO0111-CreateLogMetricFilterAndAlarm",
         "FilterName": "{{ GetMetricFilterAndAlarmInputValue.FilterName }}",
         "FilterPattern": "{{ GetMetricFilterAndAlarmInputValue.FilterPattern }}",
         "MetricName": "{{ GetMetricFilterAndAlarmInputValue.MetricName }}",
         "MetricValue": "{{ GetMetricFilterAndAlarmInputValue.MetricValue }}",
         "MetricNamespace": "{{ MetricNamespace }}",
         "AlarmName": "{{ GetMetricFilterAndAlarmInputValue.AlarmName }}",
         "AlarmDesc": "{{ GetMetricFilterAndAlarmInputValue.AlarmDesc }}",
         "AlarmThreshold": "{{ GetMetricFilterAndAlarmInputValue.AlarmThreshold }}",
         "LogGroupName": "{{ LogGroupName }}",
         "SNSTopicName": "SO0111-SHARR-LocalAlarmNotification",
         "KMSKeyArn": "{{KMSKeyArn}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Added metric filter to the log group and notifications to SNS topic SO0111-SHARR-LocalAlarmNotification.",
         "UpdatedBy": "ASR-CIS_1.2.0_3.1"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_3.1",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait2"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 3.1"
   },
   "Condition": "Enable31Condition"
  },
  "ControlCIS41": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_4.1\n\n## What does this document do?\nRemoves public access from an EC2 Security Group for controls CIS 4.1 and CIS 4.2\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Output of AWS-DisablePublicAccessForSecurityGroup runbook.\n\n## Documentation Links\n* [CIS v1.2.0 4.1](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-4.1)\n* [CIS v1.2.0 4.2](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-4.2)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 4.1 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "RemediationRoleName": {
       "type": "String",
       "default": "SO0111-DisablePublicAccessForSecurityGroup",
       "allowedPattern": "^[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "GroupId",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "RemediationRegion",
         "Selector": "$.Payload.resource_region",
         "Type": "String"
        },
        {
         "Name": "RemediationAccount",
         "Selector": "$.Payload.account_id",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):ec2:(?:[a-z]{2}(?:-gov)?-[a-z]+-[0-9]):[0-9]{12}:security-group/(sg-[a-f0-9]{8,17})$",
         "expected_control_id": [
          "4.1",
          "4.2"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       }
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "inputs": {
        "DocumentName": "AWS-DisablePublicAccessForSecurityGroup",
        "TargetLocations": [
         {
          "Accounts": [
           "{{ParseInput.RemediationAccount}}"
          ],
          "Regions": [
           "{{ParseInput.RemediationRegion}}"
          ],
          "ExecutionRoleName": "{{RemediationRoleName}}"
         }
        ],
        "RuntimeParameters": {
         "GroupId": "{{ ParseInput.GroupId }}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/{{RemediationRoleName}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Disabled public access to the security group {{ ParseInput.GroupId }}.",
         "UpdatedBy": "ASR-CIS_1.2.0_4.1"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_4.1",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait2"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 4.1"
   },
   "Condition": "Enable41Condition"
  },
  "ControlCIS43": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document Name - ASR-CIS_1.2.0_4.3\n\n## What does this document do?\nRemoves all access from an EC2 Default Security Group to restrict all traffic.\n\n## Input Parameters\n* Finding: (Required) Security Hub finding details JSON\n* AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.\n\n## Output Parameters\n* Remediation.Output - Output of remediation runbook.\n\n## Documentation Links\n[CIS v1.2.0 4.3](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-cis-controls.html#securityhub-cis-controls-4.3)\n",
     "schemaVersion": "0.3",
     "assumeRole": "{{ AutomationAssumeRole }}",
     "outputs": [
      "ParseInput.AffectedObject",
      "Remediation.Output"
     ],
     "parameters": {
      "Finding": {
       "type": "StringMap",
       "description": "The input from the Orchestrator Step function for the 4.3 finding"
      },
      "AutomationAssumeRole": {
       "type": "String",
       "description": "(Required) The ARN of the role that allows Automation to perform the actions on your behalf.",
       "allowedPattern": "^arn:(?:aws|aws-us-gov|aws-cn):iam::\\d{12}:role/[\\w+=,.@-]+$"
      },
      "RemediationRoleName": {
       "type": "String",
       "default": "SO0111-RemoveVPCDefaultSecurityGroupRules",
       "allowedPattern": "^[\\w+=,.@-]+$"
      }
     },
     "mainSteps": [
      {
       "name": "ParseInput",
       "action": "aws:executeScript",
       "outputs": [
        {
         "Name": "GroupId",
         "Selector": "$.Payload.resource_id",
         "Type": "String"
        },
        {
         "Name": "FindingId",
         "Selector": "$.Payload.finding_id",
         "Type": "String"
        },
        {
         "Name": "ProductArn",
         "Selector": "$.Payload.product_arn",
         "Type": "String"
        },
        {
         "Name": "AffectedObject",
         "Selector": "$.Payload.object",
         "Type": "StringMap"
        },
        {
         "Name": "RemediationRegion",
         "Selector": "$.Payload.resource_region",
         "Type": "String"
        },
        {
         "Name": "RemediationAccount",
         "Selector": "$.Payload.account_id",
         "Type": "String"
        }
       ],
       "inputs": {
        "InputPayload": {
         "Finding": "{{Finding}}",
         "parse_id_pattern": "^arn:(?:aws|aws-cn|aws-us-gov):ec2:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:security-group/(sg-[a-f0-9]{8,17})$",
         "expected_control_id": [
          "4.3"
         ]
        },
        "Runtime": "python3.8",
        "Handler": "parse_event",
        "Script": "# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n# SPDX-License-Identifier: Apache-2.0\nimport re\nimport json\nimport boto3\nfrom botocore.config import Config\n\ndef connect_to_config(boto_config):\n    return boto3.client('config', config=boto_config)\n\ndef connect_to_ssm(boto_config):\n    return boto3.client('ssm', config=boto_config)\n\ndef get_solution_id():\n    return 'SO0111'\n\ndef get_solution_version():\n    ssm = connect_to_ssm(\n        Config(\n            retries = {\n                'mode': 'standard'\n            },\n            user_agent_extra = f'AwsSolution/{get_solution_id()}/unknown'\n        )\n    )\n    solution_version = 'unknown'\n    try:\n        ssm_parm_value = ssm.get_parameter(\n            Name=f'/Solutions/{get_solution_id()}/member-version'\n        )['Parameter'].get('Value', 'unknown')\n        solution_version = ssm_parm_value\n    except Exception as e:\n        print(e)\n        print(f'ERROR getting solution version')\n    return solution_version\n\ndef get_shortname(long_name):\n    short_name = {\n        'aws-foundational-security-best-practices': 'AFSBP',\n        'cis-aws-foundations-benchmark': 'CIS',\n        'pci-dss': 'PCI',\n        'security-control': 'SC'\n    }\n    return short_name.get(long_name, None)\n\ndef get_config_rule(rule_name):\n    boto_config = Config(\n        retries = {\n            'mode': 'standard'\n        },\n        user_agent_extra = f'AwsSolution/{get_solution_id()}/{get_solution_version()}'\n    )\n    config_rule = None\n    try:\n        configsvc = connect_to_config(boto_config)\n        config_rule = configsvc.describe_config_rules(\n            ConfigRuleNames=[ rule_name ]\n        ).get('ConfigRules', [])[0]\n    except Exception as e:\n        print(e)\n        exit(f'ERROR getting config rule {rule_name}')\n    return config_rule\n\nclass FindingEvent:\n    \"\"\"\n    Finding object returns the parse fields from an input finding json object\n    \"\"\"\n    def _get_resource_id(self, parse_id_pattern, resource_index):\n        identifier_raw = self.finding_json['Resources'][0]['Id']\n        self.resource_id = identifier_raw\n        self.resource_id_matches = []\n\n        if parse_id_pattern:\n            identifier_match = re.match(\n                parse_id_pattern,\n                identifier_raw\n            )\n\n            if identifier_match:\n                for group in range(1, len(identifier_match.groups())+1):\n                    self.resource_id_matches.append(identifier_match.group(group))\n                self.resource_id = identifier_match.group(resource_index)\n            else:\n                exit(f'ERROR: Invalid resource Id {identifier_raw}')\n    \n    def _get_sc_check(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'security-control/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname('security-control')\n            self.control_id = match_finding_id.group(1)\n\n        return match_finding_id\n\n    def _get_standard_info(self):\n        match_finding_id = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:(?:[a-z]{2}(?:-gov)?-[a-z]+-\\d):\\d{12}:'+\n            'subscription/(.*?)/v/(\\d+\\.\\d+\\.\\d+)/(.*)/finding/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})$',\n            self.finding_json['Id']\n        )\n        if match_finding_id:\n            self.standard_id = get_shortname(match_finding_id.group(1))\n            self.standard_version = match_finding_id.group(2)\n            self.control_id = match_finding_id.group(3)\n        else:\n            match_sc_finding_id = self._get_sc_check()\n            if not match_sc_finding_id:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]}'\n\n    def _get_aws_config_rule(self):\n        # config_rule_id refers to the AWS Config Rule that produced the finding\n        if \"RelatedAWSResources:0/type\" in self.finding_json['ProductFields'] and self.finding_json['ProductFields']['RelatedAWSResources:0/type'] == 'AWS::Config::ConfigRule':\n            self.aws_config_rule_id = self.finding_json['ProductFields']['RelatedAWSResources:0/name']\n            self.aws_config_rule = get_config_rule(self.aws_config_rule_id)\n\n    def _get_region_from_resource_id(self):\n        check_for_region = re.match(\n            r'^arn:(?:aws|aws-cn|aws-us-gov):[a-zA-Z0-9]+:([a-z]{2}(?:-gov)?-[a-z]+-\\d):.*:.*$',\n            self.finding_json['Resources'][0]['Id']\n        )\n        if check_for_region:\n            self.resource_region = check_for_region.group(1)\n\n    def __init__(self, finding_json, parse_id_pattern, expected_control_id, resource_index):\n        self.valid_finding = True\n        self.resource_region = None\n        self.control_id = None\n        self.aws_config_rule_id = None\n        self.aws_config_rule = {}\n\n        \"\"\"Populate fields\"\"\"\n        # v1.5\n        self.finding_json = finding_json\n        self._get_resource_id(parse_id_pattern, resource_index)     # self.resource_id, self.resource_id_matches\n        self._get_standard_info()                                   # self.standard_id, self.standard_version, self.control_id\n\n        # V1.4\n        self.account_id = self.finding_json.get('AwsAccountId', None)    # deprecate - get Finding.AwsAccountId\n        if not re.match(r'^\\d{12}$', self.account_id) and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = f'AwsAccountId is invalid: {self.account_id}'\n        self.finding_id = self.finding_json.get('Id', None)              # deprecate\n        self.product_arn = self.finding_json.get('ProductArn', None)\n        if not re.match(r'^arn:(?:aws|aws-cn|aws-us-gov):securityhub:[a-z]{2}(?:-gov)?-[a-z]+-\\d::product/aws/securityhub$', self.product_arn):\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'ProductArn is invalid: {self.product_arn}'\n        self.details = self.finding_json['Resources'][0].get('Details', {})\n        # Test mode is used with fabricated finding data to tell the\n        # remediation runbook to run in test more (where supported)\n        # Currently not widely-used and perhaps should be deprecated.\n        self.testmode = bool('testmode' in self.finding_json)\n        self.resource = self.finding_json['Resources'][0]\n        self._get_region_from_resource_id()\n        self._get_aws_config_rule()\n        self.affected_object = {'Type': self.resource['Type'], 'Id': self.resource_id, 'OutputKey': 'Remediation.Output'}\n\n        # Validate control_id\n        if not self.control_id:\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Finding Id is invalid: {self.finding_json[\"Id\"]} - missing Control Id'\n        elif self.control_id not in expected_control_id:  # ControlId is the expected value\n            if self.valid_finding:\n                self.valid_finding = False\n                self.invalid_finding_reason = f'Control Id from input ({self.control_id}) does not match {str(expected_control_id)}'\n\n        if not self.resource_id and self.valid_finding:\n            self.valid_finding = False\n            self.invalid_finding_reason = 'Resource Id is missing from the finding json Resources (Id)'\n\n        if not self.valid_finding:\n            # Error message and return error data\n            msg = f'ERROR: {self.invalid_finding_reason}'\n            exit(msg)\n\n    def __str__(self):\n        return json.dumps(self.__dict__)\n\n'''\nMAIN\n'''\ndef parse_event(event, _):\n    finding_event = FindingEvent(event['Finding'], event['parse_id_pattern'], event['expected_control_id'], event.get('resource_index', 1))\n\n    if not finding_event.valid_finding:\n        exit('ERROR: Finding is not valid')\n\n    return {\n        \"account_id\": finding_event.account_id,\n        \"resource_id\": finding_event.resource_id,\n        \"finding_id\": finding_event.finding_id,         # Deprecate v1.5.0+\n        \"control_id\": finding_event.control_id,\n        \"product_arn\": finding_event.product_arn,       # Deprecate v1.5.0+\n        \"object\": finding_event.affected_object,\n        \"matches\": finding_event.resource_id_matches,\n        \"details\": finding_event.details,               # Deprecate v1.5.0+\n        \"testmode\": finding_event.testmode,             # Deprecate v1.5.0+\n        \"resource\": finding_event.resource,\n        \"resource_region\": finding_event.resource_region,\n        \"finding\": finding_event.finding_json,\n        \"aws_config_rule\": finding_event.aws_config_rule\n    }"
       },
       "isEnd": false
      },
      {
       "name": "Remediation",
       "action": "aws:executeAutomation",
       "isEnd": false,
       "inputs": {
        "DocumentName": "ASR-RemoveVPCDefaultSecurityGroupRules",
        "TargetLocations": [
         {
          "Accounts": [
           "{{ParseInput.RemediationAccount}}"
          ],
          "Regions": [
           "{{ParseInput.RemediationRegion}}"
          ],
          "ExecutionRoleName": "{{RemediationRoleName}}"
         }
        ],
        "RuntimeParameters": {
         "GroupId": "{{ ParseInput.GroupId }}",
         "AutomationAssumeRole": "arn:{{global:AWS_PARTITION}}:iam::{{global:ACCOUNT_ID}}:role/{{RemediationRoleName}}"
        }
       }
      },
      {
       "name": "UpdateFinding",
       "action": "aws:executeAwsApi",
       "inputs": {
        "Service": "securityhub",
        "Api": "BatchUpdateFindings",
        "FindingIdentifiers": [
         {
          "Id": "{{ParseInput.FindingId}}",
          "ProductArn": "{{ParseInput.ProductArn}}"
         }
        ],
        "Note": {
         "Text": "Removed all access to the default security group {{ ParseInput.GroupId }}.",
         "UpdatedBy": "ASR-CIS_1.2.0_4.3"
        },
        "Workflow": {
         "Status": "RESOLVED"
        }
       },
       "description": "Update finding",
       "isEnd": true
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Automation",
    "Name": "ASR-CIS_1.2.0_4.3",
    "UpdateMethod": "NewVersion"
   },
   "DependsOn": [
    "CreateWait3"
   ],
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/Control CIS 4.3"
   },
   "Condition": "Enable43Condition"
  },
  "CreateWait0": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 1,
    "UpdateIntervalSeconds": 1,
    "DeleteIntervalSeconds": 0,
    "DocumentPropertiesHash": "35746f8f644beb2df45ab0604b89d0b62ca0fdddf0a2e7646f2d9dd1085a17ba"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/CreateWait0/Default"
   }
  },
  "DeletWait0": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 0,
    "UpdateIntervalSeconds": 0,
    "DeleteIntervalSeconds": 0.5,
    "DocumentPropertiesHash": "35746f8f644beb2df45ab0604b89d0b62ca0fdddf0a2e7646f2d9dd1085a17ba"
   },
   "DependsOn": [
    "ControlCIS120",
    "ControlCIS13",
    "ControlCIS14",
    "ControlCIS15",
    "ControlCIS21"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/DeletWait0/Default"
   }
  },
  "CreateWait1": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 1,
    "UpdateIntervalSeconds": 1,
    "DeleteIntervalSeconds": 0,
    "DocumentPropertiesHash": "d04f523bf4601b58f8518b2e345769b1862fff9b3bafe0e2416fbd51b7339097"
   },
   "DependsOn": [
    "CreateWait0"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/CreateWait1/Default"
   }
  },
  "DeletWait1": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 0,
    "UpdateIntervalSeconds": 0,
    "DeleteIntervalSeconds": 0.5,
    "DocumentPropertiesHash": "d04f523bf4601b58f8518b2e345769b1862fff9b3bafe0e2416fbd51b7339097"
   },
   "DependsOn": [
    "ControlCIS22",
    "ControlCIS23",
    "ControlCIS24",
    "ControlCIS25",
    "ControlCIS26",
    "DeletWait0"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/DeletWait1/Default"
   }
  },
  "CreateWait2": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 1,
    "UpdateIntervalSeconds": 1,
    "DeleteIntervalSeconds": 0,
    "DocumentPropertiesHash": "40f4080631ffcc59677b9bc039f01a6c76e8d0aec5c77e5969658b71d7f47d8c"
   },
   "DependsOn": [
    "CreateWait1"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/CreateWait2/Default"
   }
  },
  "DeletWait2": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 0,
    "UpdateIntervalSeconds": 0,
    "DeleteIntervalSeconds": 0.5,
    "DocumentPropertiesHash": "40f4080631ffcc59677b9bc039f01a6c76e8d0aec5c77e5969658b71d7f47d8c"
   },
   "DependsOn": [
    "ControlCIS27",
    "ControlCIS28",
    "ControlCIS29",
    "ControlCIS31",
    "ControlCIS41",
    "DeletWait1"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/DeletWait2/Default"
   }
  },
  "CreateWait3": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 1,
    "UpdateIntervalSeconds": 1,
    "DeleteIntervalSeconds": 0,
    "DocumentPropertiesHash": "8b5bc8ef38b148e3e8a3ec0d39ed519450a391334ba802572822d66e84297caa"
   },
   "DependsOn": [
    "CreateWait2"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/CreateWait3/Default"
   }
  },
  "DeletWait3": {
   "Type": "Custom::Wait",
   "Properties": {
    "ServiceToken": {
     "Ref": "WaitProviderServiceToken"
    },
    "CreateIntervalSeconds": 0,
    "UpdateIntervalSeconds": 0,
    "DeleteIntervalSeconds": 0.5,
    "DocumentPropertiesHash": "8b5bc8ef38b148e3e8a3ec0d39ed519450a391334ba802572822d66e84297caa"
   },
   "DependsOn": [
    "ControlCIS43",
    "DeletWait2"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "CIS120MemberStack/DeletWait3/Default"
   }
  }
 }
}